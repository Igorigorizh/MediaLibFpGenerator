<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Celery example</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.2.0/css/bootstrap.min.css"
        integrity="sha512-XWTTruHZEYJsxV3W/lSXG1n3Q39YIWOstqvmFsdNEEQfHoZ6vm6E9GK2OrF6DSJSpIbRbi+Nn0WDPID9O7xB2Q=="
        crossorigin="anonymous" referrerpolicy="no-referrer"/>
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.1/jquery.min.js"></script>	
</head>
<body>
	

	
  <div class="container">
	
  <div class="alert alert-info alert-dismissible" id="taskRunAlert" >
    <a href="#" class="close" data-dismiss="alert" aria-label="close">&times;</a>
    <strong>Info</strong> Check live long running tasks. 
  </div>
  <div class="alert alert-warning alert-dismissible" id="taskRunAlert" >
    <a href="#" class="close" data-dismiss="alert" aria-label="close">&times;</a>
    <strong>Warning!</strong> Running tasks found. Do not start any more tasks!
  </div>
  
    <div class="row">
      <div class="col-12 col-md-10">
        <form id="your-form" action="/submit">

          <div class="mb-5">
            <label for="path" class="form-label">Root folder</label>
            <input type="text" class="form-control" id="path" name="path">
            <div class="form-check mb-3">
				  <label class="form-check-label">
					<input class="form-check-input" type="checkbox" id="fp_flag" name="fp_flag"> Generate FP
				  </label>
			</div>
			
			<div class="form-check mb-3">
				  <label class="form-check-label">
					<input class="form-check-input" type="checkbox" id="post_proc_flag" name="post_proc_flag"> with acoustId and MusicBrainz meta data request
				  </label>
				</div>
				
          </div>
          <div class="mb-3" id="messages"></div>
          <button type="submit" class="btn btn-primary">Submit</button>
		  <button type="stop" class="btn btn-primary">Stop</button>
        </form>
		
		
      </div>
	  <div class="row">
	  <br>
	  </div>
	  <div class="row">
	  <div class="col-13 col-md-5">
	  <h10>Folders scanning</h10>
	  <div class="progress">
		  <div class="progress-bar folder" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%</div>
		</div>
	  </div>
	  </div>
	  <BR> <BR>
	  <div class="row">
	  <div class="col-13 col-md-5">
	  <h10>Overall albums progress</h10>
	  <div class="progress">
		  <div class="progress-bar proc" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%</div>
		</div>
	  </div>
	  </div>
	  
    </div>
  </div>


<script>
	var error_count=0;

	function getSucessor(bar, task_id) {
    fetch(`/fp/form/task_sucessor/?task_id=${task_id}`, {
      method: 'GET',
    })
	
	 .then(response => response.json())
      .then((res) => {
        
		
		if ( 'task_id' in res ){
		 console.log(res)	
		 updateProgressBar_proc(bar, res.task_id)
		}
		
		if ( ('error' in res) && ( 'task_id' in res ) ){
		 console.log(res.error)	
		 error_count+=1
		 if ( error_count < 10 ){
		 setTimeout(function() {
            getSucessor(task_id);
          }, 5000);
		  } else {
		 
		 return;
		}
		}
		
		
	}
	)
	}
	
	
	function updateProgressBar_folder(bar, progress) {
		const succeed = progress.succeed;
		const total = progress.total;
		const taskProgress = progress.progress;
		//alert(progress.state)
		if (progress.state === 'SUCCESS') {
			alert(progress.succeed)
			const succeed = progress.succeed_final;
			const total = progress.succeed_final;
		}
		
		console.log(taskProgress);
		bar.style.width=taskProgress+"%";          
        bar.innerHTML=taskProgress+"%"+" ("+succeed+":"+total+")";
		
	}
	
	function updateProgressBar_proc(bar, task_id) {
    fetch(`/fp/form/task_subt_progress/?task_id=${task_id}`, {
      method: 'GET',
    })
	
	 .then(response => response.json())
      .then((res) => {
		
		if ( 'error' in res ){
		 console.log(res.error)	
		 error_count+=1
		 if ( error_count < 10 ){
		 setTimeout(function() {
            updateProgressBar_proc(bar, task_id);
          }, 5000);
		  } else {
		 
		 return;
		}
		}
		const taskProgress = res.progress;

		const succeed = res.succeed;
		const total = res.total;
		console.log(taskProgress);
		bar.style.width=taskProgress+"%";          
        bar.innerHTML=taskProgress+"%"+" ("+succeed+":"+total+")";
		if(taskProgress==100) {return}
        
      
	   setTimeout(function() {
            updateProgressBar_proc(bar, task_id);
          }, 5000);
		
	}
	)
	}
	

    function updateProgress(yourForm, task_id, btnHtml) {
	//Udates both progress bars
	//Bar_folder dirict from here
	//Bar_proc via getSucessor
	const bar = document.querySelector('.progress-bar.proc');
	const bar_folder = document.querySelector('.progress-bar.folder');
    fetch(`/fp/form/task_progress/?task_id=${task_id}`, {
      method: 'GET',
    })
		
      .then(response => response.json())
      .then((res) => {
        const taskStatus = res.state;
		

        if (['SUCCESS', 'FAILURE'].includes(taskStatus)) {
          const msg = yourForm.querySelector('#messages');
          const submitBtn = yourForm.querySelector('button[type="submit"]');

          if (taskStatus === 'SUCCESS') {
			updateProgressBar_folder(bar_folder, res)
            msg.innerHTML = 'root job succeeded';
			getSucessor(bar, task_id)
          } else if (taskStatus === 'FAILURE') {
            // display error message on the form
            msg.innerHTML = res.error;
          }
		  submitBtn.disabled = false;
          submitBtn.innerHTML = btnHtml;
        } else {
          // the task is still running === PENDING
		  updateProgressBar_folder(bar_folder, res)
          setTimeout(function() {
            updateProgress(yourForm, task_id, btnHtml);
          }, 1000);
        }
      })
      .catch((error) => {
          console.error('Error:', error)
        }
      );
  }


  function serialize(data) {
    let obj = {};
    for (let [key, value] of data) {
      if (obj[key] !== undefined) {
        if (!Array.isArray(obj[key])) {
          obj[key] = [obj[key]];
        }
        obj[key].push(value);
      } else {
        obj[key] = value;
      }
    }
    return obj;
  }

  document.addEventListener("DOMContentLoaded", function() {
    const yourForm = document.getElementById("your-form");
    yourForm.addEventListener("submit", function(event) {
	  error_count = 0;
      event.preventDefault();
      const submitBtn = yourForm.querySelector('button[type="submit"]');
	  //const stopBtn = yourForm.querySelector('button[type="stop"]');
      const btnHtml = submitBtn.innerHTML;
      

      // Get all field data from the form
      let data = new FormData(yourForm);
      // Convert to an object
      let formData = serialize(data);

	  if ( !formData.path){
		
		console.error('Error:', "Empty path")
		return
		}
		
	 const spinnerHtml = 'Processing...';
	  		
      submitBtn.disabled = true;
      submitBtn.innerHTML = spinnerHtml;

      const msg = yourForm.querySelector('#messages');
      msg.innerHTML = '';	

      fetch('/fp/form/', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
		  
        },
        body: JSON.stringify(formData),
      })
        .then(response => response.json())
        .then((res) => {
          // after we get Celery task id, we start polling
          const task_id = JSON.stringify(res.task_id);
          updateProgress(yourForm, task_id, btnHtml);
          console.log(res);
        })
        .catch((error) => {
            console.error('Error:', error)
          }
        );
    });
  });
  
  document.addEventListener("DOMContentLoaded", function() {
    const yourForm = document.getElementById("your-form");
    yourForm.addEventListener("stop", function(event) {
	  error_count = 0;
      event.preventDefault();
      //const submitBtn = yourForm.querySelector('button[type="submit"]');
	  const stopBtn = yourForm.querySelector('button[type="stop"]');
      const btnHtml = submitBtn.innerHTML;
      

      // Get all field data from the form
      let data = new FormData(yourForm);
      // Convert to an object
      let formData = serialize(data);

	  if ( !formData.path){
		
		console.error('Error:', "Empty path")
		return
		}
		
	 const spinnerHtml = 'Processing...';
	  		
      submitBtn.disabled = true;
      submitBtn.innerHTML = spinnerHtml;

      const msg = yourForm.querySelector('#messages');
      msg.innerHTML = '';	
		
	// request stop 	
      fetch('/fp/form/stop', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
		  
        },
        body: JSON.stringify(formData),
      })
        .then(response => response.json())
        .then((res) => {
          // after we get Celery task id, we start polling
          const task_id = JSON.stringify(res.task_id);
          updateProgress(yourForm, task_id, btnHtml);
          console.log(res);
        })
        .catch((error) => {
            console.error('Error:', error)
          }
        );
    });
  });
  
  $(document).ready(function(){
  alert('puk')
  "/form/get_current_root_task/"
  fetch(`/fp/form/get_current_root_task/`, {
      method: 'GET',
    })
		
      .then(response => response.json())
      .then((res) => {
		if ( 'message' in res){
			//const taskStatus = res.state;
			alert(res.message)
			//$("#taskRunAlert").alert("close");
		}
		
	})
        .catch((error) => {
            console.error('Error:', error)
          }
        );
			
		
  $(".close").click(function(){
	alert('puk druk')
    $("#taskRunAlert").alert("close");
  });
});
  
</script>

</body>
</html>
